#include <Arduino.h>
#include <Wire.h>
// libraries
#include "DHT.h"
#include "bmm150.h"
#include "bmm150_defs.h"

BMM150 bmm = BMM150();
DHT dht(7,DHT22);
int sensor_light = A0;
 
 void setup(){
  if(bmm.initialize() == BMM150_E_ID_NOT_CONFORM) {
    Serial.println("Chip ID can not read!");
    while(1);
  } else {
    Serial.println("Initialize done!");
  }
  dht.begin();
  Serial.begin(9600);
 }
 
 void loop(){
  int raw_light = analogRead(sensor_light);
  int light = map(raw_light, 0, 1023, 0, 100);
  Serial.print("\n");
  Serial.print("Lumière :");
  Serial.println(light);
  // Affiche la temperature et l'humidite du capteur + lumière
  Serial.println("Temperature = " + String(dht.readTemperature())+" °C");
  Serial.println("Humidite = " + String(dht.readHumidity())+" %");

  //Calcul de la position du capteur
  bmm150_mag_data value;
  bmm.read_mag_data();

  value.x = bmm.raw_mag_data.raw_datax;
  value.y = bmm.raw_mag_data.raw_datay;
  value.z = bmm.raw_mag_data.raw_dataz;

  float xyHeading = atan2(value.x, value.y);
  float zxHeading = atan2(value.z, value.x);
  float heading = xyHeading;

  if(heading < 0)
    heading += 2*PI;
  if(heading > 2*PI)
    heading -= 2*PI;
  float headingDegrees = heading * 180/M_PI;
  float xyHeadingDegrees = xyHeading * 180 / M_PI;
  float zxHeadingDegrees = zxHeading * 180 / M_PI;

  Serial.print("Heading: ");
  Serial.println(headingDegrees);

  // Attend 0.1 secondes avant de reboucler
  delay(500);
 }
